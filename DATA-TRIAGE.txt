DATA TRIAGE

-- show performances with goofy total receipts (more than 5 livres different):  (117 rows on 2014-08-21)

select id, date, total_receipts_recorded_l, sum from
  (select total_receipts_recorded_l, sum(recorded_total_l) as sum, date, registers.id from registers join ticket_sales on (register_id = registers.id) group by registers.id, registers.date, total_receipts_recorded_l order by date) as foo
  where total_receipts_recorded_l - sum > 5;


-- show dates with more than one register entry: (182 rows on 2014-08-21)

select id, date, count(*) from registers group by id, date having count(*) > 1 order by date;


-- show register entries with more than one play for a single ordering slot: (50 rows on 2014-08-29)

select register_id, date, ordering, count(*) from registers join register_plays on (register_id = registers.id) group by register_id, date, ordering having count(*) > 1 order by date;


-- show performances missing preceding order entries:  (75 rows on 2014-08-21)

select register_id, date, ordering, title from register_plays join registers on (registers.id = register_id) join plays on (plays.id = play_id) where ordering > 1 and not exists (select 1 from register_plays as foo where foo.register_id = registers.id and foo.ordering = register_plays.ordering - 1) order by date, ordering;


-- show image entries with bad filenames:  (15 rows on 2014-08-29)

select date, register_id, filepath, image_file_name from register_images join registers on (register_id = registers.id) where not image_file_name ilike 'M119_02%' order by date;